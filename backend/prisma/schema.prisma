// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model usuarios {
  id          String   @id @default(uuid()) @db.Uuid
  nombre      String
  apellidos   String
  ci          String
  correo      String   @unique
  telefono    String?
  contrasena  String   @map("contrase침a")
  rol         Rol      @default(pendiente)
  foto_perfil String?
  created_at  DateTime @default(now()) @db.Timestamp(6)
  updated_at  DateTime @updatedAt @db.Timestamp(6)

  // relaciones
  notificaciones notificaciones[] @relation("UsuarioNotificaciones")
  qrs_admin      qrs[]            @relation("QRAdmin")
  reservas       reservas[]

  // 游댳 OJO: MISMO NOMBRE DE RELACI칍N que en `model complejos`
  complejos complejos[] @relation("UsuarioComplejosAdmin")

  // 游댳 Canchas individuales del admin
  canchas_individuales canchas[] @relation("UsuarioCanchasAdmin")

  @@map("usuarios")
}

model complejos {
  id                    String      @id @default(uuid()) @db.Uuid
  nombre                String
  otb                   String
  subalcaldia           String
  celular               String
  telefono              String?
  diasDisponibles       DiaSemana[] @default([]) // Ahora opcional, se configura en edici칩n
  precioDiurnoPorHora   Decimal?    @db.Decimal(10, 2) // Opcional, se configura en edici칩n
  precioNocturnoPorHora Decimal?    @db.Decimal(10, 2) // Opcional, se configura en edici칩n
  direccion             String?
  ciudad                String?
  lat                   Decimal?    @db.Decimal(9, 6)
  lng                   Decimal?    @db.Decimal(9, 6)
  observaciones         String?
  qrUrl                 String?
  logotipo              String?

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)

  // 游댳 MISMO NOMBRE DE RELACI칍N que en `model usuarios`
  admin_id String   @db.Uuid
  admin    usuarios @relation("UsuarioComplejosAdmin", fields: [admin_id], references: [id], onDelete: Restrict)

  canchas canchas[]

  @@unique([nombre, ciudad])
  @@index([admin_id])
  @@index([ciudad])
  @@index([ciudad, nombre])
  @@map("complejos")
}

model canchas {
  id String @id @default(uuid()) @db.Uuid

  // Relaci칩n OPCIONAL con complejo
  complejo_id String?    @db.Uuid
  complejo    complejos? @relation(fields: [complejo_id], references: [id], onDelete: SetNull)

  // Relaci칩n OPCIONAL directa al admin (cancha individual)
  admin_id String?   @db.Uuid
  admin    usuarios? @relation("UsuarioCanchasAdmin", fields: [admin_id], references: [id], onDelete: SetNull)

  nombre                String
  tipoCampo             TipoCampo
  tipoCancha            TipoCancha
  otb                   String?
  subalcaldia           String?
  celular               String?
  diasDisponibles       DiaSemana[]
  observaciones         String?
  qrUrl                 String?
  direccion             String?
  ciudad                String?
  lat                   Decimal?    @db.Decimal(9, 6)
  lng                   Decimal?    @db.Decimal(9, 6)
  precioDiurnoPorHora   Decimal?    @db.Decimal(10, 2)
  precioNocturnoPorHora Decimal?    @db.Decimal(10, 2)

  // 游 Nueva configuraci칩n de horarios
  horaCorte             String?     @default("18:00") // Hora de corte para diurno/nocturno (HH:MM)

  activo                Boolean     @default(true)
  created_at            DateTime    @default(now()) @db.Timestamp(6)
  updated_at            DateTime    @updatedAt @db.Timestamp(6)

  horarios              horarios[]
  configuraciones_horarios configuraciones_horarios[]

  @@unique([complejo_id, nombre])
  @@index([complejo_id])
  @@index([admin_id])
  @@index([tipoCancha])
  @@index([ciudad])
  @@map("canchas")
}

model configuraciones_horarios {
  id              String    @id @default(uuid()) @db.Uuid
  cancha_id       String    @db.Uuid
  dia_semana      DiaSemana
  hora_inicio     String    // HH:MM (formato 24 horas)
  hora_fin        String    // HH:MM (formato 24 horas)
  created_at      DateTime  @default(now()) @db.Timestamp(6)
  updated_at      DateTime  @updatedAt @db.Timestamp(6)

  cancha canchas @relation(fields: [cancha_id], references: [id], onDelete: Cascade)

  @@unique([cancha_id, dia_semana, hora_inicio, hora_fin])
  @@index([cancha_id])
  @@map("configuraciones_horarios")
}

model horarios {
  id          String   @id @default(uuid()) @db.Uuid
  cancha_id   String   @db.Uuid
  fecha       DateTime @db.Date
  hora_inicio DateTime @db.Time(6)
  hora_fin    DateTime @db.Time(6)
  disponible  Boolean  @default(true)

  // 游 Campos para el nuevo sistema
  precio      Decimal? @db.Decimal(10, 2) // Precio espec칤fico del slot
  es_diurno   Boolean  @default(true)      // true = diurno, false = nocturno

  created_at  DateTime @default(now()) @db.Timestamp(6)
  updated_at  DateTime @updatedAt @db.Timestamp(6)

  cancha        canchas         @relation(fields: [cancha_id], references: [id], onDelete: Cascade)
  reserva_items reserva_items[]

  @@unique([cancha_id, fecha, hora_inicio, hora_fin])
  @@index([cancha_id, fecha])
  @@index([cancha_id, fecha, disponible]) // 游 Para b칰squedas de disponibilidad
  @@map("horarios")
}

model reservas {
  id         String        @id @default(uuid()) @db.Uuid
  usuario_id String        @db.Uuid
  estado     EstadoReserva @default(pendiente)

  // 游 Tipo de reserva
  tipo_reserva TipoReserva @default(diaria)

  // 游 Para reservas recurrentes
  recurrencia_dia_semana DiaSemana? // D칤a de la semana para recurrencia
  recurrencia_hora       String?     // Hora para recurrencia (HH:MM)

  created_at DateTime      @default(now()) @db.Timestamp(6)
  updated_at DateTime      @updatedAt @db.Timestamp(6)

  notificaciones notificaciones[] @relation("ReservaNotificaciones")
  pagos          pagos[]
  items          reserva_items[]

  usuario usuarios @relation(fields: [usuario_id], references: [id], onDelete: Restrict)

  @@index([usuario_id])
  @@index([tipo_reserva])
  @@map("reservas")
}

model reserva_items {
  id         String   @id @default(uuid()) @db.Uuid
  reserva_id String   @db.Uuid
  horario_id String   @db.Uuid
  precio     Decimal? @db.Decimal(10, 2)
  created_at DateTime @default(now()) @db.Timestamp(6) // NUEVO
  updated_at DateTime @updatedAt @db.Timestamp(6) // NUEVO

  horario horarios @relation(fields: [horario_id], references: [id], onDelete: Restrict) // CAMBIO
  reserva reservas @relation(fields: [reserva_id], references: [id], onDelete: Cascade) // CAMBIO

  @@unique([horario_id]) // NUEVO: un horario no puede reservarse dos veces
  @@index([reserva_id])
  @@index([horario_id])
  @@map("reserva_items")
}

model pagos {
  id          String     @id @default(uuid()) @db.Uuid
  reserva_id  String     @db.Uuid
  qr_id       String?    @db.Uuid
  estado      EstadoPago @default(pendiente)
  fecha_pago  DateTime?  @db.Timestamp(6)
  comprobante String?    @db.Text // Cambio: soportar im치genes base64 grandes
  created_at  DateTime   @default(now()) @db.Timestamp(6) // NUEVO
  updated_at  DateTime   @updatedAt @db.Timestamp(6) // NUEVO

  qr      qrs?     @relation(fields: [qr_id], references: [id], onDelete: SetNull) // CAMBIO
  reserva reservas @relation(fields: [reserva_id], references: [id], onDelete: Cascade) // CAMBIO

  @@index([reserva_id])
  @@index([qr_id])
  @@map("pagos")
}

model qrs {
  id         String   @id @default(uuid()) @db.Uuid
  admin_id   String   @db.Uuid
  imagen_qr  String   @db.Text // Cambio: soportar im치genes base64 grandes
  vigente    Boolean  @default(true)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6) // NUEVO

  pagos pagos[]
  admin usuarios @relation("QRAdmin", fields: [admin_id], references: [id], onDelete: Restrict) // CAMBIO

  @@index([admin_id])
  @@map("qrs")
}

model notificaciones {
  id         String            @id @default(uuid()) @db.Uuid
  usuario_id String            @db.Uuid
  reserva_id String?           @db.Uuid
  mensaje    String
  tipo       TipoNotificacion?
  created_at DateTime          @default(now()) @db.Timestamp(6)
  updated_at DateTime          @updatedAt @db.Timestamp(6) // NUEVO

  reserva reservas? @relation("ReservaNotificaciones", fields: [reserva_id], references: [id], onDelete: SetNull) // CAMBIO
  usuario usuarios  @relation("UsuarioNotificaciones", fields: [usuario_id], references: [id], onDelete: Cascade) // CAMBIO

  @@index([usuario_id])
  @@index([reserva_id])
  @@map("notificaciones")
}

enum Rol {
  pendiente
  cliente
  administrador
}

enum EstadoReserva {
  pendiente
  confirmada
  cancelada
}

enum EstadoPago {
  pendiente
  confirmado
  rechazado
}

enum TipoNotificacion {
  reserva_creada
  pago_confirmado
  recordatorio
}

enum DiaSemana {
  LUNES
  MARTES
  MIERCOLES
  JUEVES
  VIERNES
  SABADO
  DOMINGO
}

enum TipoCampo {
  SINTETICO
  TIERRA
  CESPED
}

enum TipoCancha {
  FUT5
  FUT6
  FUT8
  FUT11
}

enum TipoReserva {
  diaria      // D+1: solo para ma침ana
  mensual     // Bloquea horarios durante todo el mes
  recurrente  // Repite mismo d칤a/hora cada mes
}
