// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model usuarios {
  id             String           @id @default(uuid()) @db.Uuid
  nombre         String
  apellidos      String
  ci             String
  correo         String           @unique
  telefono       String?
  contrasena     String           @map("contraseña")
  rol            Rol              @default(cliente)
  foto_perfil    String?
  created_at     DateTime         @default(now()) @db.Timestamp(6)
  updated_at     DateTime         @updatedAt @db.Timestamp(6)

  //relaciones
  notificaciones notificaciones[] @relation("UsuarioNotificaciones")
  qrs_admin      qrs[]            @relation("QRAdmin")
  reservas       reservas[]
  complejos      complejos[]

  @@map("usuarios")
}

model complejos {
  id          String    @id @default(uuid()) @db.Uuid
  nombre      String
  direccion   String?
  ciudad      String?                 // NUEVO: para filtrar por ciudad
  lat         Decimal? @db.Decimal(10, 7) // NUEVO: coordenada latitud
  lng         Decimal? @db.Decimal(10, 7) // NUEVO: coordenada longitud
  telefono    String?
  logotipo    String?
  created_at  DateTime  @default(now()) @db.Timestamp(6)
  updated_at  DateTime  @updatedAt @db.Timestamp(6)

  // relación con administrador (usuario dueño del complejo)
  admin_id    String    @db.Uuid
  admin       usuarios  @relation(fields: [admin_id], references: [id], onDelete: Restrict)

  // relación con canchas
  canchas     canchas[]

  // índices y unicidad
  @@index([admin_id])
  @@index([ciudad])               // útil para búsquedas por ubicación
  @@unique([nombre, ciudad])      // evita duplicados tipo “Complejo UMSS” en la misma ciudad
  @@map("complejos")
}


model canchas {
  id          String     @id @default(uuid()) @db.Uuid
  complejo_id String     @db.Uuid
  nombre      String
  deporte     String
  superficie  String?
  precio_hora Decimal    @db.Decimal(10, 2)
  activo      Boolean    @default(true)                  // NUEVO: borrado lógico / deshabilitar
  created_at  DateTime   @default(now()) @db.Timestamp(6)
  updated_at  DateTime   @updatedAt @db.Timestamp(6)

  // Relaciones
  complejo    complejos  @relation(fields: [complejo_id], references: [id], onDelete: Cascade) // CAMBIO: si se borra el complejo, caen sus canchas
  horarios    horarios[]

  // Índices / restricciones
  @@index([complejo_id])
  @@index([deporte])                         // NUEVO: búsqueda por deporte
  @@unique([complejo_id, nombre])            // NUEVO: nombre único dentro del mismo complejo
  @@map("canchas")
}

model horarios {
  id            String          @id @default(uuid()) @db.Uuid
  cancha_id     String          @db.Uuid
  fecha         DateTime        @db.Date
  hora_inicio   DateTime        @db.Time(6)
  hora_fin      DateTime        @db.Time(6)
  disponible    Boolean         @default(true)
  created_at    DateTime        @default(now()) @db.Timestamp(6)   // NUEVO
  updated_at    DateTime        @updatedAt @db.Timestamp(6)        // NUEVO

  cancha        canchas         @relation(fields: [cancha_id], references: [id], onDelete: Cascade) // CAMBIO
  reserva_items reserva_items[]

  @@index([cancha_id, fecha])                             // NUEVO (búsquedas por día)
  @@unique([cancha_id, fecha, hora_inicio, hora_fin])     // NUEVO (evita duplicados exactos)
  @@map("horarios")
}

model reservas {
  id             String           @id @default(uuid()) @db.Uuid
  usuario_id     String           @db.Uuid
  estado         EstadoReserva    @default(pendiente)
  created_at     DateTime         @default(now()) @db.Timestamp(6)
  updated_at     DateTime         @updatedAt @db.Timestamp(6)   // NUEVO

  notificaciones notificaciones[] @relation("ReservaNotificaciones")
  pagos          pagos[]
  items          reserva_items[]

  usuario        usuarios         @relation(fields: [usuario_id], references: [id], onDelete: Restrict) // CAMBIO

  @@index([usuario_id])
  @@map("reservas")
}


model reserva_items {
  id         String   @id @default(uuid()) @db.Uuid
  reserva_id String   @db.Uuid
  horario_id String   @db.Uuid
  precio     Decimal? @db.Decimal(10, 2)
  created_at DateTime @default(now()) @db.Timestamp(6)   // NUEVO
  updated_at DateTime @updatedAt @db.Timestamp(6)        // NUEVO

  horario    horarios @relation(fields: [horario_id], references: [id], onDelete: Restrict) // CAMBIO
  reserva    reservas @relation(fields: [reserva_id], references: [id], onDelete: Cascade)  // CAMBIO

  @@index([reserva_id])
  @@index([horario_id])
  @@unique([horario_id])   // NUEVO: un horario no puede reservarse dos veces
  @@map("reserva_items")
}

model pagos {
  id         String     @id @default(uuid()) @db.Uuid
  reserva_id String     @db.Uuid
  qr_id      String?    @db.Uuid
  estado     EstadoPago @default(pendiente)
  fecha_pago DateTime?  @db.Timestamp(6)
  created_at DateTime   @default(now()) @db.Timestamp(6)  // NUEVO
  updated_at DateTime   @updatedAt @db.Timestamp(6)       // NUEVO

  qr         qrs?       @relation(fields: [qr_id], references: [id], onDelete: SetNull) // CAMBIO
  reserva    reservas   @relation(fields: [reserva_id], references: [id], onDelete: Cascade) // CAMBIO

  @@index([reserva_id])
  @@index([qr_id])
  @@map("pagos")
}


model qrs {
  id         String   @id @default(uuid()) @db.Uuid
  admin_id   String   @db.Uuid
  imagen_qr  String
  vigente    Boolean  @default(true)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)     // NUEVO

  pagos      pagos[]
  admin      usuarios @relation("QRAdmin", fields: [admin_id], references: [id], onDelete: Restrict) // CAMBIO

  @@index([admin_id])
  @@map("qrs")
}

model notificaciones {
  id         String            @id @default(uuid()) @db.Uuid
  usuario_id String            @db.Uuid
  reserva_id String?           @db.Uuid
  mensaje    String
  tipo       TipoNotificacion?
  created_at DateTime          @default(now()) @db.Timestamp(6)
  updated_at DateTime          @updatedAt @db.Timestamp(6)  // NUEVO

  reserva    reservas?         @relation("ReservaNotificaciones", fields: [reserva_id], references: [id], onDelete: SetNull) // CAMBIO
  usuario    usuarios          @relation("UsuarioNotificaciones", fields: [usuario_id], references: [id], onDelete: Cascade) // CAMBIO

  @@index([usuario_id])
  @@index([reserva_id])
  @@map("notificaciones")
}

enum Rol {
  cliente
  administrador
}

enum EstadoReserva {
  pendiente
  confirmada
  cancelada
}

enum EstadoPago {
  pendiente
  confirmado
  rechazado
}

enum TipoNotificacion {
  reserva_creada
  pago_confirmado
  recordatorio
}

enum DiaSemana {
  LUNES
  MARTES
  MIERCOLES
  JUEVES
  VIERNES
  SABADO
  DOMINGO
}


